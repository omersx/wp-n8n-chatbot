<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WordPress AI Chatbot Widget with n8n - Night Mode</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css">
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        /* 🎯 WORDPRESS SAFE CHATBOT WIDGET - NIGHT MODE */
        .wp-chatbot-widget * {
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* 🎨 CHATBOT ICON SIZE CUSTOMIZATION */
        .wp-chatbot-widget {
            --chatbot-icon-size: 52px;
            --chatbot-icon-padding: 8px;
            --chatbot-icon-mobile-size: 48px;
            --chatbot-icon-mobile-padding: 6px;
        }
        
        /* 🌙 NIGHT MODE THEME COLORS */
        .wp-chatbot-widget {
            --chatbot-primary: #007AFF;
            --chatbot-primary-hover: #0056CC;
            --chatbot-primary-solid: #007AFF;
            --chatbot-secondary: #0056CC;
            --chatbot-accent: #00B7FF;
            --chatbot-success: #34D399;
            --chatbot-error: #EF4444;
            --chatbot-warning: #F59E0B;
            
            /* Night Mode Backgrounds */
            --chatbot-bg-primary: #121212;
            --chatbot-bg-secondary: #1E1E1E;
            --chatbot-bg-tertiary: #2F2F2F;
            --chatbot-bg-chat: #1E1E1E;
            
            /* Night Mode Text Colors */
            --chatbot-text-primary: #EDEDED;
            --chatbot-text-secondary: #A0A0A0;
            --chatbot-text-muted: #6D6D6D;
            --chatbot-text-white: #FFFFFF;
            
            /* Message Bubble Colors */
            --chatbot-user-bubble: linear-gradient(135deg, #2C2C2E 0%, #232325 100%);
            --chatbot-bot-bubble: linear-gradient(135deg, #3A3A3C 0%, #313133 100%);
            --chatbot-user-bubble-solid: #2C2C2E;
            --chatbot-bot-bubble-solid: #3A3A3C;
            
            /* Border and Dividers */
            --chatbot-border-color: #2F2F2F;
            --chatbot-border-focus: #007AFF;
            
            /* Layout Variables */
            --chatbot-width: 380px;
            --chatbot-border-radius: 16px;
            --chatbot-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            --chatbot-glow: 0 0 20px rgba(0, 122, 255, 0.3);
            --chatbot-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --chatbot-position-bottom: 2rem;
            --chatbot-position-right: 2rem;
            --chatbot-position-top: 2rem;
            --chatbot-icon-position-bottom: 2rem;
            --chatbot-icon-position-right: 2rem;
        }

        /* 🤖 MAIN CHATBOT CONTAINER */
        .wp-chatbot-widget {
            font-family: var(--chatbot-font-family) !important;
            position: fixed !important;
            bottom: var(--chatbot-position-bottom) !important;
            right: var(--chatbot-position-right) !important;
            z-index: 999999 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            width: auto !important;
            height: auto !important;
        }
        
        /* 💫 CHATBOT ICON */
        .wp-chatbot-widget .chatbot-icon {
            position: fixed !important;
            right: var(--chatbot-icon-position-right) !important;
            bottom: var(--chatbot-icon-position-bottom) !important;
            z-index: 999997 !important;
            cursor: pointer !important;
            transition: transform 0.3s ease, box-shadow 0.3s ease !important;
            border-radius: 50% !important;
            background: var(--chatbot-primary) !important;
            padding: var(--chatbot-icon-padding) !important;
            box-shadow: var(--chatbot-shadow), var(--chatbot-glow) !important;
            width: calc(var(--chatbot-icon-size) + (var(--chatbot-icon-padding) * 2)) !important;
            height: calc(var(--chatbot-icon-size) + (var(--chatbot-icon-padding) * 2)) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid rgba(0, 122, 255, 0.3) !important;
        }
        
        .wp-chatbot-widget.chat-open .chatbot-icon {
            opacity: 0 !important;
            pointer-events: none !important;
            transform: scale(0.8) !important;
        }
        
        .wp-chatbot-widget .chatbot-icon:hover {
            transform: scale(1.1) rotate(5deg) !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(0, 122, 255, 0.5) !important;
            border-color: rgba(0, 122, 255, 0.6) !important;
        }
        
        .wp-chatbot-widget .chatbot-icon dotlottie-player {
            width: var(--chatbot-icon-size) !important;
            height: var(--chatbot-icon-size) !important;
            filter: brightness(1.2) !important;
        }
        
        /* 🪟 CHAT WINDOW */
        .wp-chatbot-widget .chat-window {
            position: fixed !important;
            bottom: var(--chatbot-position-bottom) !important;
            right: var(--chatbot-position-right) !important;
            width: var(--chatbot-width) !important;
            height: min(700px, calc(100vh - var(--chatbot-position-top) - var(--chatbot-position-bottom))) !important;
            background: var(--chatbot-bg-primary) !important;
            border-radius: var(--chatbot-border-radius) !important;
            box-shadow: var(--chatbot-shadow), var(--chatbot-glow) !important;
            border: 1px solid var(--chatbot-border-color) !important;
            opacity: 0 !important;
            transform: translateY(100%) scale(0.8) !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            overflow: hidden !important;
            backdrop-filter: blur(20px) !important;
            display: flex !important;
            flex-direction: column !important;
            z-index: 999998 !important;
        }
        
        .wp-chatbot-widget .chat-window.show {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }

        /* 📋 CHAT HEADER */
        .wp-chatbot-widget .chat-header {
            background: linear-gradient(135deg, var(--chatbot-primary) 0%, var(--chatbot-primary-hover) 100%) !important;
            color: var(--chatbot-text-white) !important;
            padding: 1.5rem 1.25rem !important;
            border-radius: var(--chatbot-border-radius) var(--chatbot-border-radius) 0 0 !important;
            position: relative !important;
            overflow: hidden !important;
            flex-shrink: 0 !important;
            border-bottom: 1px solid var(--chatbot-border-color) !important;
        }
        
        .wp-chatbot-widget .chat-header::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%) !important;
            pointer-events: none !important;
        }
        
        .wp-chatbot-widget .chat-header-content {
            display: flex !important;
            justify-content: space-between !important;
            align-items: flex-start !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .wp-chatbot-widget .chat-title {
            font-size: 1.25rem !important;
            font-weight: 600 !important;
            margin-bottom: 0.25rem !important;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
            line-height: 1.2 !important;
            color: var(--chatbot-text-white) !important;
        }
        
        .wp-chatbot-widget .chat-status {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            font-size: 0.875rem !important;
            opacity: 0.9 !important;
            line-height: 1 !important;
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .wp-chatbot-widget .chat-status-dot {
            width: 8px !important;
            height: 8px !important;
            border-radius: 50% !important;
            background: var(--chatbot-error) !important;
            animation: wp-chatbot-pulse 2s infinite !important;
            box-shadow: 0 0 8px currentColor !important;
        }
        
        .wp-chatbot-widget .chat-status-dot.online {
            background: var(--chatbot-success) !important;
        }
        
        .wp-chatbot-widget .chat-status-dot.connecting {
            background: var(--chatbot-warning) !important;
        }
        
        @keyframes wp-chatbot-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .wp-chatbot-widget .chat-controls {
            display: flex !important;
            gap: 0.75rem !important;
            align-items: center !important;
        }
        
        .wp-chatbot-widget .chat-new-btn {
            background: rgba(255,255,255,0.15) !important;
            border: 2px solid rgba(255,255,255,0.2) !important;
            color: var(--chatbot-text-white) !important;
            width: 40px !important;
            height: 40px !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(10px) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .wp-chatbot-widget .chat-new-btn::before {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 0 !important;
            height: 0 !important;
            background: rgba(255,255,255,0.2) !important;
            border-radius: 50% !important;
            transition: all 0.3s ease !important;
            transform: translate(-50%, -50%) !important;
        }
        
        .wp-chatbot-widget .chat-new-btn:hover::before {
            width: 100% !important;
            height: 100% !important;
        }
        
        .wp-chatbot-widget .chat-new-btn:hover {
            background: rgba(255,255,255,0.25) !important;
            border-color: rgba(255,255,255,0.4) !important;
            transform: translateY(-2px) rotate(90deg) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
        
        .wp-chatbot-widget .chat-new-btn i {
            font-size: 18px !important;
            position: relative !important;
            z-index: 1 !important;
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
        }
        
        .wp-chatbot-widget .chat-control-btn {
            background: rgba(255,255,255,0.15) !important;
            border: 2px solid rgba(255,255,255,0.2) !important;
            color: var(--chatbot-text-white) !important;
            width: 40px !important;
            height: 40px !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .wp-chatbot-widget .chat-control-btn:hover {
            background: rgba(255,255,255,0.25) !important;
            border-color: rgba(255,255,255,0.4) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }
        
        .wp-chatbot-widget .chat-control-btn i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            font-size: 16px !important;
        }

        /* 💬 MESSAGES AREA */
        .wp-chatbot-widget .chat-messages {
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 1.5rem 1.25rem !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 1rem !important;
            background: var(--chatbot-bg-chat) !important;
            position: relative !important;
            min-height: 0 !important;
        }
        
        .wp-chatbot-widget .chat-messages::-webkit-scrollbar {
            width: 6px !important;
        }
        
        .wp-chatbot-widget .chat-messages::-webkit-scrollbar-track {
            background: var(--chatbot-bg-tertiary) !important;
            border-radius: 3px !important;
        }
        
        .wp-chatbot-widget .chat-messages::-webkit-scrollbar-thumb {
            background: var(--chatbot-text-muted) !important;
            border-radius: 3px !important;
            transition: background 0.2s ease !important;
        }
        
        .wp-chatbot-widget .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--chatbot-text-secondary) !important;
        }

        /* 💬 MESSAGE BUBBLES & AVATARS */
        .wp-chatbot-widget .message-ai,
        .wp-chatbot-widget .message-user {
            display: flex !important;
            gap: 0.75rem !important;
            max-width: 85% !important;
            animation: wp-chatbot-slideIn 0.3s ease !important;
        }
        
        @keyframes wp-chatbot-slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .wp-chatbot-widget .message-ai {
            align-self: flex-start !important;
        }
        
        .wp-chatbot-widget .message-user {
            align-self: flex-end !important;
            flex-direction: row-reverse !important;
        }
        
        .wp-chatbot-widget .bot-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, var(--chatbot-primary) 0%, var(--chatbot-primary-hover) 100%) !important;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4), inset 0 1px 0 rgba(255,255,255,0.2) !important;
            flex-shrink: 0 !important;
            border: 3px solid var(--chatbot-bg-primary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: var(--chatbot-text-white) !important;
            font-size: 20px !important;
            font-weight: bold !important;
        }
        
        .wp-chatbot-widget .bot-avatar i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)) !important;
        }
        
        .wp-chatbot-widget .user-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255,255,255,0.2) !important;
            flex-shrink: 0 !important;
            border: 3px solid var(--chatbot-bg-primary) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: var(--chatbot-text-white) !important;
            font-size: 18px !important;
            font-weight: bold !important;
        }
        
        .wp-chatbot-widget .user-avatar i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)) !important;
        }
        
        .wp-chatbot-widget .message-ai .message-text {
            background: var(--chatbot-bot-bubble) !important;
            color: var(--chatbot-text-primary) !important;
            padding: 0.875rem 1rem !important;
            border-radius: 18px 18px 18px 4px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important;
            position: relative !important;
            line-height: 1.5 !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            margin: 0 !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .wp-chatbot-widget .message-user .message-text {
            background: var(--chatbot-user-bubble) !important;
            color: var(--chatbot-text-primary) !important;
            padding: 0.875rem 1rem !important;
            border-radius: 18px 18px 4px 18px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important;
            line-height: 1.5 !important;
            margin: 0 !important;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px) !important;
        }

        /* 🎨 ENHANCED N8N TEXT FORMATTING SUPPORT */
        .wp-chatbot-widget .message-text h1,
        .wp-chatbot-widget .message-text h2,
        .wp-chatbot-widget .message-text h3,
        .wp-chatbot-widget .message-text h4,
        .wp-chatbot-widget .message-text h5,
        .wp-chatbot-widget .message-text h6 {
            margin: 0.8rem 0 0.4rem 0 !important;
            color: inherit !important;
            font-weight: 600 !important;
            line-height: 1.3 !important;
        }
        
        .wp-chatbot-widget .message-text h1 { font-size: 1.5rem !important; }
        .wp-chatbot-widget .message-text h2 { font-size: 1.3rem !important; }
        .wp-chatbot-widget .message-text h3 { font-size: 1.2rem !important; }
        .wp-chatbot-widget .message-text h4 { font-size: 1.1rem !important; }
        .wp-chatbot-widget .message-text h5 { font-size: 1rem !important; }
        .wp-chatbot-widget .message-text h6 { font-size: 0.9rem !important; }
        
        .wp-chatbot-widget .message-text p {
            margin: 0.5rem 0 !important;
            line-height: 1.6 !important;
        }
        
        .wp-chatbot-widget .message-text strong,
        .wp-chatbot-widget .message-text b {
            font-weight: 600 !important;
            color: var(--chatbot-text-white) !important;
        }
        
        .wp-chatbot-widget .message-text em,
        .wp-chatbot-widget .message-text i {
            font-style: italic !important;
        }
        
        /* Code formatting - inline and blocks */
        .wp-chatbot-widget .message-text code {
            background: rgba(0, 122, 255, 0.15) !important;
            padding: 0.2rem 0.4rem !important;
            border-radius: 4px !important;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace !important;
            font-size: 0.9em !important;
            color: var(--chatbot-accent) !important;
            border: 1px solid rgba(0, 122, 255, 0.2) !important;
        }
        
        .wp-chatbot-widget .message-text pre {
            background: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid var(--chatbot-border-color) !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            margin: 0.8rem 0 !important;
            overflow-x: auto !important;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace !important;
            font-size: 0.85rem !important;
            line-height: 1.45 !important;
            position: relative !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .wp-chatbot-widget .message-text pre code {
            background: none !important;
            padding: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            color: var(--chatbot-text-primary) !important;
        }
        
        /* Lists with enhanced styling */
        .wp-chatbot-widget .message-text ul,
        .wp-chatbot-widget .message-text ol {
            margin: 0.8rem 0 !important;
            padding-left: 1.8rem !important;
        }
        
        .wp-chatbot-widget .message-text li {
            margin: 0.4rem 0 !important;
            line-height: 1.5 !important;
            color: var(--chatbot-text-primary) !important;
        }
        
        .wp-chatbot-widget .message-text ul > li {
            list-style-type: disc !important;
        }
        
        .wp-chatbot-widget .message-text ol > li {
            list-style-type: decimal !important;
        }
        
        /* Nested lists */
        .wp-chatbot-widget .message-text ul ul,
        .wp-chatbot-widget .message-text ol ol,
        .wp-chatbot-widget .message-text ul ol,
        .wp-chatbot-widget .message-text ol ul {
            margin: 0.2rem 0 !important;
            padding-left: 1.5rem !important;
        }
        
        /* Blockquotes */
        .wp-chatbot-widget .message-text blockquote {
            border-left: 4px solid var(--chatbot-primary) !important;
            margin: 0.8rem 0 !important;
            padding: 0.5rem 1rem !important;
            background: rgba(0, 122, 255, 0.1) !important;
            border-radius: 0 8px 8px 0 !important;
            font-style: italic !important;
            color: var(--chatbot-text-secondary) !important;
        }
        
        /* Links */
        .wp-chatbot-widget .message-text a {
            color: var(--chatbot-accent) !important;
            text-decoration: underline !important;
            transition: color 0.2s ease !important;
        }
        
        .wp-chatbot-widget .message-text a:hover {
            color: var(--chatbot-primary) !important;
            text-decoration: none !important;
        }
        
        /* Tables with enhanced styling */
        .wp-chatbot-widget .message-text table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 0.8rem 0 !important;
            font-size: 0.9rem !important;
            border: 1px solid var(--chatbot-border-color) !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            background: rgba(0, 0, 0, 0.2) !important;
        }
        
        .wp-chatbot-widget .message-text th,
        .wp-chatbot-widget .message-text td {
            border: 1px solid var(--chatbot-border-color) !important;
            padding: 0.6rem 0.8rem !important;
            text-align: left !important;
        }
        
        .wp-chatbot-widget .message-text th {
            background: rgba(0, 122, 255, 0.2) !important;
            font-weight: 600 !important;
            color: var(--chatbot-text-white) !important;
        }
        
        .wp-chatbot-widget .message-text tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        .wp-chatbot-widget .message-text tbody tr:hover {
            background: rgba(0, 122, 255, 0.1) !important;
        }
        
        /* Horizontal rules */
        .wp-chatbot-widget .message-text hr {
            border: none !important;
            border-top: 2px solid var(--chatbot-border-color) !important;
            margin: 1.5rem 0 !important;
            border-radius: 1px !important;
        }
        
        /* Task lists (checkboxes) */
        .wp-chatbot-widget .message-text input[type="checkbox"] {
            margin-right: 0.5rem !important;
            pointer-events: none !important;
        }
        
        /* Strikethrough text */
        .wp-chatbot-widget .message-text del,
        .wp-chatbot-widget .message-text s {
            text-decoration: line-through !important;
            opacity: 0.7 !important;
        }
        
        /* Subscript and superscript */
        .wp-chatbot-widget .message-text sub,
        .wp-chatbot-widget .message-text sup {
            font-size: 0.75em !important;
            line-height: 0 !important;
            position: relative !important;
            vertical-align: baseline !important;
        }
        
        .wp-chatbot-widget .message-text sup {
            top: -0.5em !important;
        }
        
        .wp-chatbot-widget .message-text sub {
            bottom: -0.25em !important;
        }
        
        /* Keyboard keys */
        .wp-chatbot-widget .message-text kbd {
            background: var(--chatbot-bg-tertiary) !important;
            border: 1px solid var(--chatbot-border-color) !important;
            border-radius: 4px !important;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1), 0 0 0 2px rgba(0,0,0,0.2) inset !important;
            color: var(--chatbot-text-primary) !important;
            display: inline-block !important;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace !important;
            font-size: 0.85em !important;
            font-weight: 700 !important;
            line-height: 1 !important;
            padding: 2px 4px !important;
            white-space: nowrap !important;
        }
        
        /* Abbreviations */
        .wp-chatbot-widget .message-text abbr {
            border-bottom: 1px dotted var(--chatbot-text-secondary) !important;
            cursor: help !important;
        }
        
        /* Marks/highlighting */
        .wp-chatbot-widget .message-text mark {
            background: rgba(245, 158, 11, 0.3) !important;
            padding: 0.1rem 0.2rem !important;
            border-radius: 2px !important;
            color: var(--chatbot-text-white) !important;
        }

        /* Copy Button */
        .wp-chatbot-widget .copy-btn {
            position: absolute !important;
            top: 0.5rem !important;
            right: 0.5rem !important;
            background: rgba(0, 0, 0, 0.6) !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 0.25rem !important;
            cursor: pointer !important;
            opacity: 0 !important;
            transition: all 0.2s ease !important;
            font-size: 0.75rem !important;
            color: var(--chatbot-text-secondary) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .wp-chatbot-widget .copy-btn i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 400 !important;
        }
        
        .wp-chatbot-widget .message-ai:hover .copy-btn {
            opacity: 1 !important;
        }
        
        .wp-chatbot-widget .copy-btn:hover {
            background: var(--chatbot-primary) !important;
            color: var(--chatbot-text-white) !important;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5) !important;
        }

        /* 📝 INPUT AREA */
        .wp-chatbot-widget .chat-input-area {
            padding: 1.25rem !important;
            background: var(--chatbot-bg-primary) !important;
            border-radius: 0 0 var(--chatbot-border-radius) var(--chatbot-border-radius) !important;
            border-top: 1px solid var(--chatbot-border-color) !important;
            flex-shrink: 0 !important;
        }
        
        .wp-chatbot-widget .chat-input-form {
            display: flex !important;
            gap: 0.75rem !important;
            align-items: flex-end !important;
            background: var(--chatbot-bg-secondary) !important;
            border-radius: 24px !important;
            padding: 0.5rem !important;
            border: 2px solid var(--chatbot-border-color) !important;
            transition: all 0.2s ease !important;
        }
        
        .wp-chatbot-widget .chat-input-form:focus-within {
            border-color: var(--chatbot-border-focus) !important;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2), 0 0 20px rgba(0, 122, 255, 0.1) !important;
        }
        
        .wp-chatbot-widget .chat-input {
            flex: 1 !important;
            border: none !important;
            background: none !important;
            padding: 0.75rem 1rem !important;
            font-size: 1rem !important;
            color: var(--chatbot-text-primary) !important;
            resize: none !important;
            font-family: inherit !important;
            max-height: 100px !important;
            min-height: 20px !important;
            overflow-y: auto !important;
            outline: none !important;
            line-height: 1.4 !important;
        }
        
        .wp-chatbot-widget .chat-input::placeholder {
            color: var(--chatbot-text-muted) !important;
        }
        
        .wp-chatbot-widget .chat-send-btn {
            background: linear-gradient(135deg, var(--chatbot-primary) 0%, var(--chatbot-primary-hover) 100%) !important;
            border: none !important;
            border-radius: 50% !important;
            width: 44px !important;
            height: 44px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            color: var(--chatbot-text-white) !important;
            flex-shrink: 0 !important;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3) !important;
        }
        
        .wp-chatbot-widget .chat-send-btn i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
            font-size: 16px !important;
        }
        
        .wp-chatbot-widget .chat-send-btn:hover:not(:disabled) {
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.5), 0 0 20px rgba(0, 122, 255, 0.3) !important;
        }
        
        .wp-chatbot-widget .chat-send-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            transform: none !important;
            background: var(--chatbot-text-muted) !important;
        }

        /* 🔄 LOADING ANIMATION */
        .wp-chatbot-widget .loading-screen {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(18, 18, 18, 0.95) !important;
            display: none !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 1rem !important;
            backdrop-filter: blur(20px) !important;
            z-index: 10 !important;
        }
        
        .wp-chatbot-widget .loading-screen i {
            font-size: 2rem !important;
            color: var(--chatbot-primary) !important;
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
        }
        
        .wp-chatbot-widget .loading-screen p {
            color: var(--chatbot-text-secondary) !important;
            font-weight: 500 !important;
            margin: 0 !important;
        }

        /* ⌨️ TYPING ANIMATION */
        .wp-chatbot-widget .typing-animation {
            display: flex !important;
            gap: 0.75rem !important;
            align-items: flex-end !important;
        }
        
        .wp-chatbot-widget .typing-dots {
            background: var(--chatbot-bot-bubble) !important;
            padding: 1rem !important;
            border-radius: 18px 18px 18px 4px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(10px) !important;
        }
        
        .wp-chatbot-widget .typing-dot {
            animation: 1.4s wp-chatbot-typing infinite ease-in-out !important;
            fill: var(--chatbot-text-secondary) !important;
        }
        
        .wp-chatbot-widget .typing-dot:nth-child(2) {
            animation-delay: 0.2s !important;
        }
        
        .wp-chatbot-widget .typing-dot:nth-child(3) {
            animation-delay: 0.4s !important;
        }
        
        @keyframes wp-chatbot-typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Error message styling */
        .wp-chatbot-widget .message-error {
            background: rgba(239, 68, 68, 0.2) !important;
            border: 1px solid var(--chatbot-error) !important;
            color: var(--chatbot-error) !important;
            padding: 0.75rem 1rem !important;
            border-radius: 12px !important;
            margin: 0.5rem 0 !important;
            font-size: 0.875rem !important;
            text-align: center !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            gap: 0.5rem !important;
            backdrop-filter: blur(10px) !important;
        }

        .wp-chatbot-widget .retry-btn {
            background: var(--chatbot-error) !important;
            color: white !important;
            border: none !important;
            padding: 0.5rem 1rem !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 0.875rem !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3) !important;
        }

        .wp-chatbot-widget .retry-btn:hover {
            background: #dc2626 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
        }

        .wp-chatbot-widget .retry-btn i {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important;
        }

        .wp-chatbot-widget .char-count {
            font-size: 0.75rem !important;
            color: var(--chatbot-text-muted) !important;
            text-align: right !important;
            margin-top: 0.25rem !important;
        }

        .wp-chatbot-widget .char-count.warning {
            color: var(--chatbot-warning) !important;
        }

        .wp-chatbot-widget .char-count.error {
            color: var(--chatbot-error) !important;
        }

        /* 📱 RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .wp-chatbot-widget {
                --chatbot-position-bottom: 1rem !important;
                --chatbot-position-right: 1rem !important;
                --chatbot-icon-position-bottom: 1.5rem !important;
                --chatbot-icon-position-right: 1.5rem !important;
            }

            .wp-chatbot-widget .chat-window {
                width: calc(100vw - 2rem) !important;
                max-width: 400px !important;
                bottom: 1rem !important;
                right: 1rem !important;
                height: min(490px, calc(100vh - 2rem)) !important;
            }

            .wp-chatbot-widget .chat-header {
                padding: 1rem 1.25rem !important;
            }

            .wp-chatbot-widget .chat-title {
                font-size: 1.125rem !important;
            }

            .wp-chatbot-widget .chat-messages {
                padding: 1rem !important;
            }

            .wp-chatbot-widget .chat-input-area {
                padding: 1rem !important;
            }

            .wp-chatbot-widget .chatbot-icon {
                padding: var(--chatbot-icon-mobile-padding) !important;
                width: calc(var(--chatbot-icon-mobile-size) + (var(--chatbot-icon-mobile-padding) * 2)) !important;
                height: calc(var(--chatbot-icon-mobile-size) + (var(--chatbot-icon-mobile-padding) * 2)) !important;
            }
            
            .wp-chatbot-widget .chatbot-icon dotlottie-player {
                width: var(--chatbot-icon-mobile-size) !important;
                height: var(--chatbot-icon-mobile-size) !important;
            }
        }

        @media (max-width: 480px) {
            .wp-chatbot-widget .chat-window {
                width: calc(100vw - 1rem) !important;
                right: 0.5rem !important;
                bottom: 0.5rem !important;
                height: min(480px, calc(100vh - 1rem)) !important;
            }

            .wp-chatbot-widget .chat-header {
                padding: 0.875rem 1rem !important;
            }

            .wp-chatbot-widget .chat-messages {
                padding: 0.75rem !important;
                gap: 0.75rem !important;
            }

            .wp-chatbot-widget .chat-input-area {
                padding: 0.875rem !important;
            }

            .wp-chatbot-widget .chatbot-icon {
                right: 1rem !important;
                bottom: 1rem !important;
            }
        }

        /* WordPress admin bar compatibility */
        .admin-bar .wp-chatbot-widget {
            top: calc(var(--chatbot-position-top) + 32px) !important;
        }
        
        @media screen and (max-width: 782px) {
            .admin-bar .wp-chatbot-widget {
                top: calc(var(--chatbot-position-top) + 46px) !important;
            }
        }
    </style>
</head>
<body>
    <div class="wp-chatbot-widget" id="wp-chatbot-widget">
        <div class="chatbot-icon" onclick="wpChatbotToggle()" role="button" tabindex="0" 
             aria-label="Open AI Chatbot" onkeypress="wpChatbotHandleKeyPress(event)">
            <dotlottie-player
                src="https://lottie.host/feefeb87-8206-4b50-8696-bda4747b4fdf/uUJIo0ICb6.json"
                background="transparent"
                speed="1"
                loop
                autoplay>
            </dotlottie-player>
        </div>
        
        <div class="chat-window" id="chat-window" role="dialog" aria-labelledby="chat-title" aria-modal="true">
            <div class="loading-screen" id="loading-screen" role="status" aria-live="polite">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <p>Connecting...</p>
            </div>
            
            <div class="chat-header">
                <div class="chat-header-content">
                    <div>
                        <div class="chat-title" id="chat-title">AI Assistant</div>
                        <div class="chat-status">
                            <span class="chat-status-dot" id="status-dot"></span>
                            <span id="chat-status">Connecting...</span>
                        </div>
                    </div>
                    <div class="chat-controls">
                        <button class="chat-new-btn" title="New Chat" onclick="wpChatbotNewChat()"
                                aria-label="Start new conversation">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                        <button class="chat-control-btn" onclick="wpChatbotToggle()" title="Close Chat"
                                aria-label="Close chatbot">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Chat messages">
                <!-- Messages will be dynamically added here -->
            </div>
            
            <div class="chat-input-area">
                <form class="chat-input-form" id="chat-form" onsubmit="wpChatbotSendMessage(event)">
                    <textarea
                        class="chat-input"
                        id="chat-input"
                        name="message"
                        placeholder="Type your message..."
                        autocomplete="off"
                        required
                        rows="1"
                        maxlength="2000"
                        aria-label="Type your message"
                    ></textarea>
                    <button type="submit" class="chat-send-btn" id="send-btn" aria-label="Send message">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
                <div class="char-count" id="char-count">0/2000</div>
            </div>
        </div>
    </div>

    <script>
        // 🔧 N8N CHATBOT CONFIGURATION
        const WP_CHATBOT_CONFIG = {
            // 🔗 n8n Configuration
            N8N_WEBHOOK_URL: "YOUR_N8N_WEBHOOK_URL_HERE",
            N8N_CHAT_INPUT_KEY: "chatInput",
            N8N_SESSION_KEY: "sessionId",
            
            // 🤖 Bot Identity
            BOT_NAME: "AI Assistant",
            BOT_AVATAR_ICON: "fa-solid fa-robot",
            USER_AVATAR_ICON: "fa-solid fa-user",
            
            // 💬 Welcome Message
            WELCOME_MESSAGE: "Hello! I'm your AI assistant. How can I help you today? Let us Go 🤖",
            
            // ⚙️ Behavior Settings
            TYPING_SPEED: 30,
            ANIMATION_DURATION: 300,
            INITIALIZATION_DELAY: 1200,
            MAX_MESSAGE_LENGTH: 2000,
            MAX_MESSAGES: 100,
            
            // 🔌 API Settings
            API_TIMEOUT: 60000,
            MAX_RETRIES: 3,
            RETRY_DELAY: 2000,
            
            // 🎨 UI Settings
            AUTO_RESIZE_INPUT: true,
            SHOW_TIMESTAMPS: false,
            SHOW_CHAR_COUNT: true,
            ENABLE_MARKDOWN: true,
            ENABLE_HTML: true,
        };

        // 🔄 GLOBAL VARIABLES
        let wpChatbotIsOpen = false;
        let wpChatbotMessages = [];
        let wpChatbotIsInitialized = false;
        let wpChatbotIsTyping = false;
        let wpChatbotSessionId = wpChatbotGenerateSessionId();
        let wpChatbotApiCallCount = 0;
        let wpChatbotRetryCount = 0;
        let wpChatbotAbortController = null;

        // 🛠️ UTILITY FUNCTIONS
        function wpChatbotGenerateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function wpChatbotSanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        function wpChatbotHandleKeyPress(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                wpChatbotToggle();
            }
        }

        function wpChatbotAutoResizeTextarea(textarea) {
            if (!WP_CHATBOT_CONFIG.AUTO_RESIZE_INPUT) return;
            
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        function wpChatbotUpdateCharCount() {
            if (!WP_CHATBOT_CONFIG.SHOW_CHAR_COUNT) return;
            
            const input = document.getElementById('chat-input');
            const charCount = document.getElementById('char-count');
            
            if (!input || !charCount) return;
            
            const current = input.value.length;
            const max = WP_CHATBOT_CONFIG.MAX_MESSAGE_LENGTH;
            
            charCount.textContent = `${current}/${max}`;
            
            charCount.className = 'char-count';
            if (current > max * 0.9) {
                charCount.classList.add('warning');
            }
            if (current >= max) {
                charCount.classList.add('error');
            }
        }

        // 🎨 ENHANCED N8N TEXT PROCESSING
        function wpChatbotProcessN8nResponse(content) {
            if (!content) return '';

            // Handle different n8n response formats
            let processedContent = content;

            // Convert n8n-style formatting to standard markdown
            processedContent = wpChatbotConvertN8nFormatting(processedContent);

            // Process markdown
            if (WP_CHATBOT_CONFIG.ENABLE_MARKDOWN) {
                processedContent = wpChatbotRenderMarkdown(processedContent);
            }

            // Sanitize HTML
            if (WP_CHATBOT_CONFIG.ENABLE_HTML) {
                processedContent = wpChatbotSanitizeHTML(processedContent);
            } else {
                processedContent = wpChatbotEscapeHtml(processedContent);
            }

            return processedContent;
        }

        function wpChatbotConvertN8nFormatting(text) {
            // Convert n8n specific formatting patterns
            return text
                // Bold text: **text** or __text__
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                
                // Italic text: *text* or _text_
                .replace(/(?<!\*)\*([^\*\n]+?)\*(?!\*)/g, '<em>$1</em>')
                .replace(/(?<!_)_([^_\n]+?)_(?!_)/g, '<em>$1</em>')
                
                // Strikethrough: ~~text~~
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                
                // Code: `code`
                .replace(/`([^`\n]+?)`/g, '<code>$1</code>')
                
                // Code blocks: ```code```
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                
                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                
                // Lists
                .replace(/^\* (.+)$/gm, '<li>$1</li>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.+)$/gm, '<li>$1. $2</li>')
                
                // Links: [text](url)
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                
                // Wrap in paragraphs if not already wrapped
                .replace(/^(?!<[h|u|o|p|d|b])/gm, '<p>')
                .replace(/(?<!>)$/gm, '</p>')
                
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                .replace(/<p>(<[h|u|o|d|b])/g, '$1')
                .replace(/(<\/[h|u|o|d|b]>)<\/p>/g, '$1');
        }

        function wpChatbotRenderMarkdown(text) {
            if (!WP_CHATBOT_CONFIG.ENABLE_MARKDOWN) return text;
            
            try {
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false,
                    smartLists: true,
                    smartypants: true,
                    highlight: function(code, lang) {
                        if (window.Prism && Prism.languages[lang]) {
                            return Prism.highlight(code, Prism.languages[lang], lang);
                        }
                        return code;
                    }
                });
                
                return marked.parse(text);
            } catch (error) {
                console.warn('Markdown parsing error:', error);
                return wpChatbotEscapeHtml(text);
            }
        }

        function wpChatbotSanitizeHTML(content) {
            if (!WP_CHATBOT_CONFIG.ENABLE_HTML) {
                return wpChatbotEscapeHtml(content);
            }
            
            // Remove dangerous elements
            return content
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '')
                .replace(/javascript:/gi, '')
                .replace(/on\w+\s*=/gi, '')
                .replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '')
                .replace(/<embed\b[^>]*>/gi, '')
                .replace(/<applet\b[^<]*(?:(?!<\/applet>)<[^<]*)*<\/applet>/gi, '');
        }

        function wpChatbotEscapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 🔌 N8N WEBHOOK INTEGRATION
        async function wpChatbotCallN8nWebhook(userMessage, action = 'sendMessage') {
            if (!WP_CHATBOT_CONFIG.N8N_WEBHOOK_URL || WP_CHATBOT_CONFIG.N8N_WEBHOOK_URL === "YOUR_N8N_WEBHOOK_URL_HERE") {
                throw new Error('n8n webhook URL not configured. Please set your webhook URL in the configuration.');
            }

            if (wpChatbotAbortController) {
                wpChatbotAbortController.abort();
            }
            
            wpChatbotAbortController = new AbortController();
            
            const requestData = {
                [WP_CHATBOT_CONFIG.N8N_CHAT_INPUT_KEY]: userMessage,
                [WP_CHATBOT_CONFIG.N8N_SESSION_KEY]: wpChatbotSessionId,
                action: action,
                timestamp: Date.now()
            };

            const url = new URL(WP_CHATBOT_CONFIG.N8N_WEBHOOK_URL);
            url.searchParams.append('action', action);

            console.log('🚀 Sending request to n8n webhook:', {
                url: url.toString(),
                action: action,
                sessionId: wpChatbotSessionId,
                messageLength: userMessage.length
            });

            try {
                const requestOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: wpChatbotAbortController.signal
                };

                const response = await fetch(url.toString(), requestOptions);

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    
                    try {
                        const errorData = await response.json();
                        if (errorData.error || errorData.message) {
                            errorMessage = errorData.error || errorData.message;
                        }
                    } catch (e) {
                        // Use default error message
                    }
                    
                    if (response.status === 404) {
                        errorMessage = 'n8n workflow not found. Please check your webhook URL.';
                    } else if (response.status === 500) {
                        errorMessage = 'n8n workflow error. Please check your workflow configuration.';
                    } else if (response.status === 403) {
                        errorMessage = 'Access denied. Please check your CORS settings in n8n.';
                    }
                    
                    throw new Error(errorMessage);
                }

                const contentType = response.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const textResponse = await response.text();
                    data = { message: textResponse };
                }

                // Extract AI response with multiple fallback options
                let aiResponse;
                if (data.output) {
                    aiResponse = data.output;
                } else if (data.message) {
                    aiResponse = data.message;
                } else if (data.response) {
                    aiResponse = data.response;
                } else if (data.text) {
                    aiResponse = data.text;
                } else if (data.content) {
                    aiResponse = data.content;
                } else if (data.result) {
                    aiResponse = data.result;
                } else if (typeof data === 'string') {
                    aiResponse = data;
                } else {
                    aiResponse = JSON.stringify(data, null, 2);
                }

                wpChatbotApiCallCount++;
                console.log('✅ n8n webhook call successful:', {
                    callCount: wpChatbotApiCallCount,
                    responseLength: aiResponse.length,
                    sessionId: wpChatbotSessionId
                });
                
                return aiResponse;

            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('Request was cancelled');
                }
                
                console.error('❌ n8n Webhook Error:', error);
                throw error;
            }
        }

        // 🎮 CORE FUNCTIONS
        function wpChatbotToggle() {
            const chatWindow = document.getElementById('chat-window');
            const widget = document.getElementById('wp-chatbot-widget');
            
            wpChatbotIsOpen = !wpChatbotIsOpen;
            
            if (wpChatbotIsOpen) {
                chatWindow.classList.add('show');
                widget.classList.add('chat-open');
                widget.style.zIndex = '999999';
                
                if (!wpChatbotIsInitialized) {
                    wpChatbotInitialize();
                }
                
                setTimeout(() => {
                    const input = document.getElementById('chat-input');
                    if (input) {
                        input.focus();
                        wpChatbotScrollToBottom();
                    }
                }, 400);
            } else {
                chatWindow.classList.remove('show');
                widget.classList.remove('chat-open');
                setTimeout(() => {
                    widget.style.zIndex = '999998';
                }, 400);
            }
        }

        function wpChatbotNewChat() {
            wpChatbotMessages = [];
            wpChatbotSessionId = wpChatbotGenerateSessionId();
            wpChatbotRetryCount = 0;
            
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';
            
            wpChatbotAddMessage('ai', WP_CHATBOT_CONFIG.WELCOME_MESSAGE);
            
            const input = document.getElementById('chat-input');
            if (input) {
                input.value = '';
                wpChatbotAutoResizeTextarea(input);
                wpChatbotUpdateCharCount();
            }

            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
                sendBtn.disabled = false;
            }

            wpChatbotUpdateStatus('online', 'Online');
        }

        async function wpChatbotSendMessage(event, customMessage) {
            if (event) event.preventDefault();
            
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            
            if (wpChatbotIsTyping || (sendBtn && sendBtn.disabled)) return;
            
            let message = customMessage || (input ? input.value.trim() : '');
            if (!message || message.length > WP_CHATBOT_CONFIG.MAX_MESSAGE_LENGTH) return;

            message = wpChatbotSanitizeInput(message);

            wpChatbotIsTyping = true;
            if (sendBtn) {
                sendBtn.disabled = true;
            }

            wpChatbotMessages.push({
                role: 'user',
                message: message,
                timestamp: Date.now()
            });

            wpChatbotAddMessage('user', message);
            
            if (input) {
                input.value = '';
                wpChatbotAutoResizeTextarea(input);
                wpChatbotUpdateCharCount();
            }
            
            wpChatbotAddTypingAnimation();

            try {
                const response = await wpChatbotCallN8nWebhook(message, 'sendMessage');
                const processedResponse = wpChatbotProcessN8nResponse(response);
                await wpChatbotAddBotResponse(processedResponse);
                wpChatbotRetryCount = 0;
                
            } catch (error) {
                console.error('Chatbot API Error:', error);
                wpChatbotHandleError(error, message);
            } finally {
                wpChatbotIsTyping = false;
                if (sendBtn) {
                    sendBtn.disabled = false;
                }
                if (input) input.focus();
            }
        }

        function wpChatbotHandleError(error, originalMessage = null) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            let errorMessage = 'Sorry, something went wrong. Please try again.';
            let showRetry = true;
            
            if (error.message.includes('webhook URL')) {
                errorMessage = '🔗 n8n webhook not configured. Please contact support.';
                showRetry = false;
            } else if (error.message.includes('workflow not found')) {
                errorMessage = '🔍 n8n workflow not found. Please check the webhook URL.';
                showRetry = false;
            } else if (error.message.includes('workflow error')) {
                errorMessage = '⚙️ n8n workflow error. Please try again or contact support.';
            } else if (error.message.includes('Access denied')) {
                errorMessage = '🚫 Access denied. Please check CORS settings.';
                showRetry = false;
            } else if (error.message.includes('cancelled')) {
                errorMessage = '🚫 Request was cancelled.';
                showRetry = false;
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                errorMessage = '🌐 Network error. Please check your connection and try again.';
            }

            wpChatbotShowError(errorMessage, showRetry, originalMessage);
        }

        function wpChatbotShowError(errorMessage, showRetry = false, originalMessage = null) {
            const chatMessages = document.getElementById('chat-messages');
            const errorContainer = document.createElement('div');
            errorContainer.classList.add('message-error');
            
            let retryButton = '';
            if (showRetry && wpChatbotRetryCount < WP_CHATBOT_CONFIG.MAX_RETRIES && originalMessage) {
                retryButton = `
                    <button class="retry-btn" onclick="wpChatbotRetryLastMessage('${originalMessage.replace(/'/g, "\\'")}')">
                        <i class="fa-solid fa-redo"></i> Retry (${wpChatbotRetryCount + 1}/${WP_CHATBOT_CONFIG.MAX_RETRIES})
                    </button>
                `;
            }
            
            errorContainer.innerHTML = `
                <i class="fa-solid fa-exclamation-triangle"></i>
                <span>${errorMessage}</span>
                ${retryButton}
            `;
            
            chatMessages.appendChild(errorContainer);
            wpChatbotScrollToBottom();
        }

        async function wpChatbotRetryLastMessage(originalMessage = null) {
            const errorMsg = document.querySelector('.wp-chatbot-widget .message-error');
            if (errorMsg) {
                errorMsg.remove();
            }

            wpChatbotRetryCount++;
            
            await new Promise(resolve => setTimeout(resolve, WP_CHATBOT_CONFIG.RETRY_DELAY));
            
            if (originalMessage) {
                wpChatbotSendMessage(null, originalMessage);
            }
        }

        function wpChatbotUpdateStatus(status, message) {
            const statusElement = document.getElementById('chat-status');
            const statusDot = document.getElementById('status-dot');
            
            if (wpChatbotIsInitialized && message !== 'Online') {
                return; 
            }
            
            if (statusElement) statusElement.textContent = message;
            
            if (statusDot) {
                statusDot.className = 'chat-status-dot';
                if (status === 'online') {
                    statusDot.classList.add('online');
                } else if (status === 'connecting') {
                    statusDot.classList.add('connecting');
                }
            }
        }

        function wpChatbotAddMessage(sender, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageContainer = document.createElement('div');
            messageContainer.classList.add(`message-${sender}`);

            const avatarIcon = sender === 'ai' 
                ? WP_CHATBOT_CONFIG.BOT_AVATAR_ICON 
                : WP_CHATBOT_CONFIG.USER_AVATAR_ICON;

            const timestamp = WP_CHATBOT_CONFIG.SHOW_TIMESTAMPS 
                ? `<span class="message-time">${new Date().toLocaleTimeString()}</span>` 
                : '';

            if (sender === 'ai') {
                const processedMessage = wpChatbotProcessN8nResponse(message);
                
                messageContainer.innerHTML = `
                    <div class="bot-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-text">
                        ${processedMessage}
                        ${timestamp}
                        <button class="copy-btn" onclick="wpChatbotCopyText(event)" title="Copy message"
                                aria-label="Copy message to clipboard">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                `;
            } else {
                messageContainer.innerHTML = `
                    <div class="message-text">${wpChatbotEscapeHtml(message)}${timestamp}</div>
                    <div class="user-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                `;
            }

            chatMessages.appendChild(messageContainer);
            
            if (sender === 'ai' && window.Prism) {
                Prism.highlightAllUnder(messageContainer);
            }
            
            wpChatbotManageMessageLimit();
            wpChatbotScrollToBottom();
        }

        function wpChatbotManageMessageLimit() {
            const chatMessages = document.getElementById('chat-messages');
            const messages = chatMessages.querySelectorAll('.message-ai, .message-user');
            
            if (messages.length > WP_CHATBOT_CONFIG.MAX_MESSAGES) {
                const messagesToRemove = messages.length - WP_CHATBOT_CONFIG.MAX_MESSAGES;
                for (let i = 1; i <= messagesToRemove; i++) {
                    if (messages[i]) {
                        messages[i].remove();
                    }
                }
            }
        }

        function wpChatbotAddTypingAnimation() {
            const chatMessages = document.getElementById('chat-messages');
            const typingContainer = document.createElement('div');
            typingContainer.classList.add('message-ai', 'typing-animation');
            typingContainer.id = 'typing-indicator';
            
            typingContainer.innerHTML = `
                <div class="bot-avatar">
                    <i class="${WP_CHATBOT_CONFIG.BOT_AVATAR_ICON}"></i>
                </div>
                <div class="typing-dots">
                    <svg height="16" width="40">
                        <circle class="typing-dot" cx="10" cy="8" r="3" />
                        <circle class="typing-dot" cx="20" cy="8" r="3" />
                        <circle class="typing-dot" cx="30" cy="8" r="3" />
                    </svg>
                </div>
            `;
            
            chatMessages.appendChild(typingContainer);
            wpChatbotScrollToBottom();
        }

        async function wpChatbotAddBotResponse(message) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }

            const chatMessages = document.getElementById('chat-messages');
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message-ai');
            
            const timestamp = WP_CHATBOT_CONFIG.SHOW_TIMESTAMPS 
                ? `<span class="message-time">${new Date().toLocaleTimeString()}</span>` 
                : '';
            
            messageContainer.innerHTML = `
                <div class="bot-avatar">
                    <i class="${WP_CHATBOT_CONFIG.BOT_AVATAR_ICON}"></i>
                </div>
                <div class="message-text typing-effect">${timestamp}</div>
            `;
            
            chatMessages.appendChild(messageContainer);

            const typingElement = messageContainer.querySelector('.typing-effect');
            let index = 0;
            const plainText = message.replace(/<[^>]*>/g, '');
            
            return new Promise((resolve) => {
                const typeMessage = () => {
                    if (index < plainText.length) {
                        typingElement.textContent = (timestamp ? '' : '') + plainText.substring(0, index + 1);
                        index++;
                        setTimeout(typeMessage, WP_CHATBOT_CONFIG.TYPING_SPEED);
                    } else {
                        typingElement.innerHTML = message + timestamp + `
                            <button class="copy-btn" onclick="wpChatbotCopyText(event)" title="Copy message"
                                    aria-label="Copy message to clipboard">
                                <i class="fa-regular fa-copy"></i>
                            </button>
                        `;
                        
                        if (window.Prism) {
                            Prism.highlightAllUnder(typingElement);
                        }
                        
                        resolve();
                    }
                    wpChatbotScrollToBottom();
                };
                
                typeMessage();
            });

            wpChatbotMessages.push({
                role: 'assistant',
                message: message,
                timestamp: Date.now()
            });
        }

        function wpChatbotScrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function wpChatbotCopyText(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const messageElement = event.target.closest('.message-text');
            let textToCopy = messageElement.textContent.replace('📋', '').trim();
            
            textToCopy = textToCopy.replace(/Copy message.*$/, '').trim();
            if (WP_CHATBOT_CONFIG.SHOW_TIMESTAMPS) {
                textToCopy = textToCopy.replace(/\d{1,2}:\d{2}:\d{2}\s?(AM|PM)?.*$/, '').trim();
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-check"></i>';
                button.style.background = 'var(--chatbot-success)';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.background = '';
                }, 2000);
            }).catch(error => {
                console.error('Copy failed:', error);
            });
        }

        // 🚀 INITIALIZATION
        function wpChatbotInitialize() {
            if (wpChatbotIsInitialized) return;
            
            const loadingScreen = document.getElementById('loading-screen');
            const chatTitle = document.getElementById('chat-title');

            if (chatTitle) chatTitle.textContent = WP_CHATBOT_CONFIG.BOT_NAME;

            if (loadingScreen) loadingScreen.style.display = 'flex';
            wpChatbotUpdateStatus('connecting', 'Connecting...');

            setTimeout(() => {
                if (loadingScreen) loadingScreen.style.display = 'none';
                
                wpChatbotUpdateStatus('online', 'Online');
                wpChatbotIsInitialized = true;

                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) chatMessages.innerHTML = '';

                wpChatbotAddMessage('ai', WP_CHATBOT_CONFIG.WELCOME_MESSAGE);
                
                console.log('🌙 n8n AI Chatbot (Night Mode) initialized successfully', {
                    webhookUrl: WP_CHATBOT_CONFIG.N8N_WEBHOOK_URL.substring(0, 50) + '...',
                    sessionId: wpChatbotSessionId
                });
            }, WP_CHATBOT_CONFIG.INITIALIZATION_DELAY);
        }

        // 🎧 EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            const chatForm = document.getElementById('chat-form');
            
            if (chatInput) {
                chatInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        wpChatbotSendMessage(event);
                    }
                });

                chatInput.addEventListener('input', (event) => {
                    wpChatbotAutoResizeTextarea(event.target);
                    wpChatbotUpdateCharCount();
                });
            }

            if (chatForm) {
                chatForm.addEventListener('submit', wpChatbotSendMessage);
            }

            wpChatbotUpdateCharCount();

            // Hide in WordPress admin
            if (document.body.classList.contains('wp-admin')) {
                const widget = document.getElementById('wp-chatbot-widget');
                if (widget) {
                    widget.style.display = 'none';
                }
            }

            // Handle visibility change
            document.addEventListener('visibilitychange', function() {
                const lottiePlayer = document.querySelector('dotlottie-player');
                if (lottiePlayer) {
                    if (document.hidden) {
                        lottiePlayer.pause();
                    } else {
                        lottiePlayer.play();
                    }
                }
            });
        });

        window.addEventListener('resize', function() {
            if (wpChatbotIsOpen) {
                wpChatbotScrollToBottom();
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && wpChatbotIsOpen) {
                wpChatbotToggle();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (wpChatbotAbortController) {
                wpChatbotAbortController.abort();
            }
            wpChatbotMessages = [];
        });
    </script>
</body>
</html>
